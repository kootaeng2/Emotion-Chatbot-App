name: Sync to Hugging Face hub

on:
  push:
    branches: [main]

jobs:
  sync-to-hub:
    runs-on: ubuntu-latest
    steps:
      # 1. GitHub 저장소의 코드를 가져옵니다. (LFS 파일 포함)
      - uses: actions/checkout@v2 # 안정성을 위해 v2를 사용
        with:
          fetch-depth: 0
          lfs: false

      # 2. 깨끗한 버전의 내역을 만들어서 Hugging Face Hub에 푸시합니다.
      - name: Push clean history to Hugging Face Hub
        env:
          HF_TOKEN: ${{ secrets.TOKEN }} # GitHub Secret 이름은 TOKEN으로 유지
        run: |
          # Git 사용자 정보 및 원격 저장소 설정
          git config --global user.email "hf@example.com"
          git config --global user.name "Hugging Face"
          git remote add hf "https://huggingface.co/spaces/taehoon222/emotion-chatbot-app"
          git config --global credential.helper store
          
          # 올바른 변수 이름인 HF_TOKEN을 사용하도록 수정
          echo "https://user:${HF_TOKEN}@huggingface.co" > $HOME/.git-credentials

          # .env 파일이 존재할 경우 강제 삭제
          rm -f .env

          # 새로운 브랜치를 만들어 과거 기록을 모두 제거하고 푸시
          git checkout --orphan clean-history
          git add -A
          git commit -m "Deploy clean snapshot of the repository"
          git push --force hf clean-history:main